name: Deploy Home Lab

# Trigger: Run this pipeline when code is pushed to the 'main' branch
on:
  push:
    branches: [ "main" ]

jobs:
  configure-node:
    runs-on: self-hosted  # FIXED: Indented to be inside 'configure-node'

    steps:
      # Step 1: Pull the latest code from GitHub
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Force Install Latest Ansible (Fixes 'end_role' error)
      - name: Install Ansible
        run: |
          echo "Removing old Ansible..."
          sudo apt-get remove -y ansible
          sudo apt-get autoremove -y
          
          echo "Installing fresh Ansible via Pip..."
          sudo apt-get update
          sudo apt-get install -y python3-pip
          sudo pip3 install ansible --break-system-packages
      # Step 3: Create a temporary password file
      - name: Create Vault Pass File
        run: echo "${{ secrets.VAULT_PASS }}" > .vault_pass

      # Step 4: Run the Tailscale Playbook
      - name: Run Tailscale Playbook
        run: |  # FIXED: Indented block
          cd playbooks
          ansible-playbook tailscale.yml --vault-password-file ../.vault_pass
        env:
          ANSIBLE_FORCE_COLOR: '1'

      # Step 5: Clean up the password file
      - name: Cleanup Secrets
        if: always()
        run: rm -f .vault_pass
